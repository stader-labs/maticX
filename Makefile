# Binaries
BIN_HARDHAT := ./node_modules/.bin/hardhat
BIN_ECHIDNA := echidna
BIN_MYTH := myth

# Configs
CONFIG_ECHIDNA := echidna.config.yaml
CONFIG_SOLC := solc.json

# Networks
NETWORK_HARDHAT := hardhat
NETWORK_LOCALHOST := localhost
NETWORK_SEPOLIA := sepolia
NETWORK_AMOY := amoy
NETWORK_ETHEREUM := ethereum
NETWORK_POLYGON := polygon

# Hardhat contract addresses
HARDHAT_VALIDATOR_REGISTRY := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_MATIC_X := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_CHILD_POOL := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_STAKE_MANAGER := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_CHECKPOINT_MANAGER := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_FX_ROOT := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_FX_CHILD := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_FX_STATE_ROOT_TUNNEL := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_FX_STATE_CHILD_TUNNEL := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_MATIC_TOKEN := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_POL_TOKEN := 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
HARDHAT_MANAGER := 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
HARDHAT_TREASURY := 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
HARDHAT_INSTANT_POOL_OWNER := 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266

# Localhost contract addresses
LOCALHOST_VALIDATOR_REGISTRY :=
LOCALHOST_MATIC_X :=
LOCALHOST_CHILD_POOL :=
LOCALHOST_STAKE_MANAGER :=
LOCALHOST_CHECKPOINT_MANAGER :=
LOCALHOST_FX_ROOT :=
LOCALHOST_FX_CHILD :=
LOCALHOST_FX_STATE_ROOT_TUNNEL :=
LOCALHOST_FX_STATE_CHILD_TUNNEL :=
LOCALHOST_MATIC_TOKEN :=
LOCALHOST_POL_TOKEN :=
LOCALHOST_MANAGER :=
LOCALHOST_TREASURY :=
LOCALHOST_INSTANT_POOL_OWNER :=

# Sepolia contract addresses
SEPOLIA_VALIDATOR_REGISTRY := 0xE98fc808E8aE8025a1D17d6F4Fbc3Df226788438
SEPOLIA_MATIC_X := 0xB51AAb302085F436204c4B1964fBE74517B2D4b6
SEPOLIA_STAKE_MANAGER := 0x4AE8f648B1Ec892B6cc68C89cc088583964d08bE
SEPOLIA_CHECKPOINT_MANAGER := 0xbd07D7E1E93c8d4b2a261327F3C28a8EA7167209
SEPOLIA_FX_ROOT := 0x0E13EBEdDb8cf9f5987512d5E081FdC2F5b0991e
SEPOLIA_FX_STATE_ROOT_TUNNEL := 0x1316e16f56a5A05538277906E12b77F2B39B4d79
SEPOLIA_MATIC_TOKEN := 0x3fd0A53F4Bf853985a95F4Eb3F9C9FDE1F8e2b53
SEPOLIA_POL_TOKEN := 0x44499312f493F62f2DFd3C6435Ca3603EbFCeeBa
SEPOLIA_MANAGER := 0x369B31971250859d3AD37E7cEDCF42AA5CF2C4F4
SEPOLIA_TREASURY := 0xdeb90df43BBa8FC0e2C08C54dC0F48cfc694F896

# Amoy contract addresses
AMOY_MATIC_X := 0xFD837d45dd6Af18D039122301C3331D4A4307351
AMOY_CHILD_POOL := 0x54a994B66FA7eA7160D6281002B56a041db0b5a5
AMOY_FX_CHILD := 0xE5930336866d0388f0f745A2d9207C7781047C0f
AMOY_FX_STATE_CHILD_TUNNEL := 0xDC5e26af83c1694A655beBe22689f12A42573d94
AMOY_MANAGER := 0x8C6B3eE457b193A49794df466957441b4AccD102
AMOY_TREASURY := 0x8C6B3eE457b193A49794df466957441b4AccD102
AMOY_INSTANT_POOL_OWNER := 0x8C6B3eE457b193A49794df466957441b4AccD102

# Ethereum contract addresses
ETHEREUM_VALIDATOR_REGISTRY := 0xf556442D5B77A4B0252630E15d8BbE2160870d77
ETHEREUM_MATIC_X := 0xf03A7Eb46d01d9EcAA104558C732Cf82f6B6B645
ETHEREUM_STAKE_MANAGER := 0x5e3ef299fddf15eaa0432e6e66473ace8c13d908
ETHEREUM_CHECKPOINT_MANAGER := 0x86e4dc95c7fbdbf52e33d563bbdb00823894c287
ETHEREUM_FX_ROOT := 0xfe5e5D361b2ad62c541bAb87C45a0B9B018389a2
ETHEREUM_FX_STATE_ROOT_TUNNEL := 0x40FB804Cc07302b89EC16a9f8d040506f64dFe29
ETHEREUM_MATIC_TOKEN := 0x7D1AfA7B718fb893dB30A3aBc0Cfc608AaCfeBB0
ETHEREUM_POL_TOKEN := 0x455e53CBB86018Ac2B8092FdCd39d8444aFFC3F6
ETHEREUM_MANAGER := 0x80A43dd35382C4919991C5Bca7f46Dd24Fde4C67
ETHEREUM_TREASURY := 0x01422247a1d15BB4FcF91F5A077Cf25BA6460130

# Polygon contract addresses
POLYGON_MATIC_X := 0xfa68FB4628DFF1028CFEc22b4162FCcd0d45efb6
POLYGON_CHILD_POOL := 0xfd225C9e6601C9d38d8F98d8731BF59eFcF8C0E3
POLYGON_FX_CHILD := 0x8397259c983751DAf40400790063935a11afa28a
POLYGON_FX_STATE_CHILD_TUNNEL := 0x97E58a6950D86d751082D5e1d350e74c19047570
POLYGON_MANAGER := 0x80A43dd35382C4919991C5Bca7f46Dd24Fde4C67
POLYGON_TREASURY := 0x80A43dd35382C4919991C5Bca7f46Dd24Fde4C67
POLYGON_INSTANT_POOL_OWNER := 0x51358004cFe135E64453d7F6a0dC433CAba09A2a

# Contract paths
CONTRACT_PATH_VALIDATOR_REGISTRY := contracts/ValidatorRegistry.sol
CONTRACT_PATH_MATIC_X := contracts/MaticX.sol
CONTRACT_PATH_CHILD_POOL := contracts/ChildPool.sol

all: hardhat

hardhat: deploy-validatorregistry-hardhat deploy-childpool-hardhat deploy-fxstateroottunnel-hardhat deploy-fxstatechildtunnel-hardhat

localhost: deploy-validatorregistry-localhost deploy-childpool-localhost deploy-fxstateroottunnel-localhost deploy-fxstatechildtunnel-localhost

# Deploy the ValidatorRegistry contract
deploy-validatorregistry-hardhat:
	$(BIN_HARDHAT) deploy:validator-registry --network $(NETWORK_HARDHAT) --stake-manager $(HARDHAT_STAKE_MANAGER) --matic-token $(HARDHAT_MATIC_TOKEN) --matic-x $(HARDHAT_MATIC_X) --manager $(HARDHAT_MANAGER)
deploy-validatorregistry-localhost:
	$(BIN_HARDHAT) deploy:validator-registry --network $(NETWORK_LOCALHOST) --stake-manager $(LOCALHOST_STAKE_MANAGER) --matic-token $(LOCALHOST_MATIC_TOKEN) --matic-x $(LOCALHOST_MATIC_X) --manager $(LOCALHOST_MANAGER)
deploy-validatorregistry-sepolia:
	$(BIN_HARDHAT) deploy:validator-registry --network $(NETWORK_SEPOLIA) --stake-manager $(SEPOLIA_STAKE_MANAGER) --matic-token $(SEPOLIA_MATIC_TOKEN) --matic-x $(SEPOLIA_MATIC_X) --manager $(SEPOLIA_MANAGER)
deploy-validatorregistry-ethereum:
	$(BIN_HARDHAT) deploy:validator-registry --network $(NETWORK_ETHEREUM) --stake-manager $(ETHEREUM_STAKE_MANAGER) --matic-token $(ETHEREUM_MATIC_TOKEN) --matic-x $(ETHEREUM_MATIC_X) --manager $(ETHEREUM_MANAGER)

# Deploy the MaticX contract
deploy-maticx-hardhat:
	$(BIN_HARDHAT) deploy:matic-x --network $(NETWORK_HARDHAT) --validator-registry $(HARDHAT_VALIDATOR_REGISTRY) --stake-manager $(HARDHAT_STAKE_MANAGER) --matic-token $(HARDHAT_MATIC_TOKEN) --manager $(HARDHAT_MANAGER) --treasury $(HARDHAT_TREASURY)
deploy-maticx-localhost:
	$(BIN_HARDHAT) deploy:matic-x --network $(NETWORK_LOCALHOST) --validator-registry $(LOCALHOST_VALIDATOR_REGISTRY) --stake-manager $(LOCALHOST_STAKE_MANAGER) --matic-token $(LOCALHOST_MATIC_TOKEN) --manager $(LOCALHOST_MANAGER) --treasury $(LOCALHOST_TREASURY)
deploy-maticx-sepolia:
	$(BIN_HARDHAT) deploy:matic-x --network $(NETWORK_SEPOLIA) --validator-registry $(SEPOLIA_VALIDATOR_REGISTRY) --stake-manager $(SEPOLIA_STAKE_MANAGER) --matic-token $(SEPOLIA_MATIC_TOKEN) --manager $(SEPOLIA_MANAGER) --treasury $(SEPOLIA_TREASURY)
deploy-maticx-amoy:
	$(BIN_HARDHAT) deploy:u-child-erc20 --network $(NETWORK_AMOY) --name "Liquid Staking Matic (PoS)" --symbol "MaticX" --child-chain-manager $(AMOY_MANAGER)
deploy-maticx-ethereum:
	$(BIN_HARDHAT) deploy:matic-x --network $(NETWORK_ETHEREUM) --validator-registry $(ETHEREUM_VALIDATOR_REGISTRY) --stake-manager $(ETHEREUM_STAKE_MANAGER) --matic-token $(ETHEREUM_MATIC_TOKEN) --manager $(ETHEREUM_MANAGER) --treasury $(ETHEREUM_TREASURY)
deploy-maticx-polygon:
	$(BIN_HARDHAT) deploy:u-child-erc20 --network $(NETWORK_POLYGON) --name "Liquid Staking Matic (PoS)" --symbol "MaticX" --child-chain-manager $(POLYGON_MANAGER)

# Deploy the ChildPool contract
deploy-childpool-hardhat:
	$(BIN_HARDHAT) deploy:child-pool --network $(NETWORK_HARDHAT) --fx-state-child-tunnel $(HARDHAT_FX_STATE_CHILD_TUNNEL) --matic-x $(HARDHAT_MATIC_X) --manager $(HARDHAT_MANAGER) --instant-pool-owner $(HARDHAT_INSTANT_POOL_OWNER) --treasury $(HARDHAT_TREASURY)
deploy-childpool-localhost:
	$(BIN_HARDHAT) deploy:child-pool --network $(NETWORK_LOCALHOST) --fx-state-child-tunnel $(LOCALHOST_FX_STATE_CHILD_TUNNEL) --matic-x $(LOCALHOST_MATIC_X) --manager $(LOCALHOST_MANAGER) --instant-pool-owner $(LOCALHOST_INSTANT_POOL_OWNER) --treasury $(LOCALHOST_TREASURY)
deploy-childpool-amoy:
	$(BIN_HARDHAT) deploy:child-pool --network $(NETWORK_AMOY) --fx-state-child-tunnel $(AMOY_FX_STATE_CHILD_TUNNEL) --matic-x $(AMOY_MATIC_X) --manager $(AMOY_MANAGER) --instant-pool-owner $(AMOY_INSTANT_POOL_OWNER) --treasury $(AMOY_TREASURY)
deploy-childpool-polygon:
	$(BIN_HARDHAT) deploy:child-pool --network $(NETWORK_POLYGON) --fx-state-child-tunnel $(POLYGON_FX_STATE_CHILD_TUNNEL) --matic-x $(POLYGON_MATIC_X) --manager $(POLYGON_MANAGER) --instant-pool-owner $(POLYGON_INSTANT_POOL_OWNER) --treasury $(POLYGON_TREASURY)

# Deploy the FxStateRootTunnel contract
deploy-fxstateroottunnel-hardhat:
	$(BIN_HARDHAT) deploy:fx-state-root-tunnel --network $(NETWORK_HARDHAT) --checkpoint-manager $(HARDHAT_CHECKPOINT_MANAGER) --fx-root $(HARDHAT_FX_ROOT) --matic-x $(HARDHAT_MATIC_X)
deploy-fxstateroottunnel-localhost:
	$(BIN_HARDHAT) deploy:fx-state-root-tunnel --network $(NETWORK_LOCALHOST) --checkpoint-manager $(LOCALHOST_CHECKPOINT_MANAGER) --fx-root $(LOCALHOST_FX_ROOT) --matic-x $(LOCALHOST_MATIC_X)
deploy-fxstateroottunnel-sepolia:
	$(BIN_HARDHAT) deploy:fx-state-root-tunnel --network $(NETWORK_SEPOLIA) --checkpoint-manager $(SEPOLIA_CHECKPOINT_MANAGER) --fx-root $(SEPOLIA_FX_ROOT) --matic-x $(SEPOLIA_MATIC_X)
deploy-fxstateroottunnel-ethereum:
	$(BIN_HARDHAT) deploy:fx-state-root-tunnel --network $(NETWORK_ETHEREUM) --checkpoint-manager $(ETHEREUM_CHECKPOINT_MANAGER) --fx-root $(ETHEREUM_FX_ROOT) --matic-x $(ETHEREUM_MATIC_X)

# Deploy the FxStateChildTunnel contract
deploy-fxstatechildtunnel-hardhat:
	$(BIN_HARDHAT) deploy:fx-state-child-tunnel --network $(NETWORK_HARDHAT) --fx-child $(HARDHAT_FX_CHILD)
deploy-fxstatechildtunnel-localhost:
	$(BIN_HARDHAT) deploy:fx-state-child-tunnel --network $(NETWORK_LOCALHOST) --fx-child $(LOCALHOST_FX_CHILD)
deploy-fxstatechildtunnel-amoy:
	$(BIN_HARDHAT) deploy:fx-state-child-tunnel --network $(NETWORK_AMOY) --fx-child $(AMOY_FX_CHILD)
deploy-fxstatechildtunnel-polygon:
	$(BIN_HARDHAT) deploy:fx-state-child-tunnel --network $(NETWORK_POLYGON) --fx-child $(POLYGON_FX_CHILD)

# Initialize v2 the ValidatorRegistry contract
initializev2-validatorregistry-sepolia:
	$(BIN_HARDHAT) initialize-v2:validator-registry --network $(NETWORK_SEPOLIA) --contract $(SEPOLIA_VALIDATOR_REGISTRY) --pol-token $(SEPOLIA_POL_TOKEN)
initializev2-validatorregistry-ethereum:
	$(BIN_HARDHAT) initialize-v2:validator-registry --network $(NETWORK_ETHEREUM) --contract $(ETHEREUM_VALIDATOR_REGISTRY) --pol-token $(ETHEREUM_POL_TOKEN)

# Initialize v2 the MaticX contract
initializev2-maticx-sepolia:
	$(BIN_HARDHAT) initialize-v2:matic-x --network $(NETWORK_SEPOLIA) --contract $(SEPOLIA_MATIC_X) --pol-token $(SEPOLIA_POL_TOKEN)
initializev2-maticx-ethereum:
	$(BIN_HARDHAT) initialize-v2:matic-x --network $(NETWORK_ETHEREUM) --contract $(ESEPOLIA_MATIC_X) --pol-token $(ETHEREUM_POL_TOKEN)

# Upgrade the ValidatorRegistry contract
upgrade-validatorregistry-localhost:
	$(BIN_HARDHAT) upgrade-contract --network $(NETWORK_LOCALHOST) --name ValidatorRegistry --contract $(LOCALHOST_VALIDATOR_REGISTRY)
upgrade-validatorregistry-sepolia:
	$(BIN_HARDHAT) upgrade-contract --network $(NETWORK_SEPOLIA) --name ValidatorRegistry --contract $(SEPOLIA_VALIDATOR_REGISTRY)
upgrade-validatorregistry-ethereum:
	$(BIN_HARDHAT) upgrade-contract --network $(NETWORK_ETHEREUM) --name ValidatorRegistry --contract $(ETHEREUM_VALIDATOR_REGISTRY)

# Upgrade the MaticX contract
upgrade-maticx-localhost:
	$(BIN_HARDHAT) upgrade-contract --network $(NETWORK_LOCALHOST) --name MaticX --contract $(LOCALHOST_MATIC_X) --unsafe true
upgrade-maticx-sepolia:
	$(BIN_HARDHAT) upgrade-contract --network $(NETWORK_SEPOLIA) --name MaticX --contract $(SEPOLIA_MATIC_X) --unsafe true
upgrade-maticx-ethereum:
	$(BIN_HARDHAT) upgrade-contract --network $(NETWORK_ETHEREUM) --name MaticX --contract $(ETHEREUM_MATIC_X) --unsafe true

# Verify the ValidatorRegistry contract
verify-validatorregistry-sepolia:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_SEPOLIA) --contract $(SEPOLIA_VALIDATOR_REGISTRY)
verify-validatorregistry-ethereum:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_ETHEREUM) --contract $(ETHEREUM_VALIDATOR_REGISTRY)

# Verify the MaticX contract
verify-maticx-sepolia:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_SEPOLIA) --contract $(SEPOLIA_MATIC_X)
verify-maticx-amoy:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_AMOY) --contract $(AMOY_MATIC_X)
verify-maticx-ethereum:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_ETHEREUM) --contract $(ETHEREUM_MATIC_X)
verify-maticx-polygon:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_POLYGON) --contract $(POLYGON_MATIC_X)

# Verify the ChildPool contract
verify-childpool-amoy:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_AMOY) --contract $(AMOY_CHILD_POOL)
verify-childpool-polygon:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_POLYGON) --contract $(POLYGON_CHILD_POOL)

# Verify the FxStateRootTunnel contract
verify-fxstateroottunnel-sepolia:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_SEPOLIA) --contract $(SEPOLIA_FX_STATE_ROOT_TUNNEL) "$(SEPOLIA_CHECKPOINT_MANAGER)" "$(SEPOLIA_FX_ROOT)" "$(SEPOLIA_MATIC_X)"
verify-fxstateroottunnel-ethereum:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_ETHEREUM) --contract $(ETHEREUM_FX_STATE_ROOT_TUNNEL) "$(ETHEREUM_CHECKPOINT_MANAGER)" "$(ETHEREUM_FX_ROOT)" "$(ETHEREUM_MATIC_X)"

# Verify the FxStateChildTunnel contract
verify-fxstatechildtunnel-amoy:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_AMOY) --contract $(AMOY_FX_STATE_CHILD_TUNNEL) "$(AMOY_FX_CHILD)"
verify-fxstatechildtunnel-polygon:
	$(BIN_HARDHAT) verify-contract --network $(NETWORK_POLYGON) --contract $(POLYGON_FX_STATE_CHILD_TUNNEL) "$(POLYGON_FX_CHILD)"

# Import the ValidatorRegistry contract
import-validatorregistry-sepolia:
	$(BIN_HARDHAT) import-contract --network $(NETWORK_SEPOLIA) --name ValidatorRegistry --contract $(SEPOLIA_VALIDATOR_REGISTRY)
import-validatorregistry-ethereum:
	$(BIN_HARDHAT) import-contract --network $(NETWORK_ETHEREUM) --name ValidatorRegistry --contract $(ETHEREUM_VALIDATOR_REGISTRY)

# Import the MaticX contract
import-maticx-sepolia:
	$(BIN_HARDHAT) import-contract --network $(NETWORK_SEPOLIA) --name MaticX --contract $(SEPOLIA_MATIC_X)
import-maticx-ethereum:
	$(BIN_HARDHAT) import-contract --network $(NETWORK_ETHEREUM) --name MaticX --contract $(ETHEREUM_MATIC_X)

# Analyze contracts with mythril
analyze-mytrhil-validatorregistry:
	$(BIN_MYTH) analyze $(CONTRACT_PATH_VALIDATOR_REGISTRY) --solc-json $(CONFIG_SOLC)
analyze-mytrhil-maticx:
	$(BIN_MYTH) analyze $(CONTRACT_PATH_MATIC_X) --solc-json $(CONFIG_SOLC)

# Fuzz test contracts with echidna
fuzz-echidna-maticx:
	$(BIN_ECHIDNA) . --contract FuzzMaticX $(CONFIG_ECHIDNA)
